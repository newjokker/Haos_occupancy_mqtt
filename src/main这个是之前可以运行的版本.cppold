#include <Arduino.h>
#include <WiFi.h>
#include <PubSubClient.h>

const int SENSOR_PIN = 33;      // ä¼ æ„Ÿå™¨è¿æ¥çš„å¼•è„š
const int LED_PIN = 2;          // æ¿è½½LEDå¼•è„šï¼ˆé€šå¸¸æ˜¯GPIO2ï¼‰

bool lastState = false;         // ä¸Šä¸€æ¬¡çš„çŠ¶æ€
bool currentState = false;      // å½“å‰çŠ¶æ€
bool systemBooted = false;      // ç³»ç»Ÿæ˜¯å¦å·²å¯åŠ¨å®Œæˆ
unsigned long lastLedBlink = 0; // LEDé—ªçƒè®¡æ—¶
bool ledState = false;          // LEDå½“å‰çŠ¶æ€

// çŠ¶æ€æ— å˜åŒ–æ£€æµ‹ç›¸å…³å˜é‡
unsigned long lastStateChangeTime = 0;  // ä¸Šæ¬¡çŠ¶æ€å˜åŒ–çš„æ—¶é—´
unsigned long lastStatePublishTime = 0; // ä¸Šæ¬¡çŠ¶æ€å‘å¸ƒçš„æ—¶é—´
const unsigned long STATE_CHANGE_INTERVAL = 5 * 60 * 1000; // 5åˆ†é’Ÿï¼ˆæ¯«ç§’ï¼‰

// WiFié…ç½®
const char* ssid = "Saturn-Guest-2.4g";
const char* password = "Tuxingkeji-0918";

// MQTTé…ç½® - è¯·æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹
const char* mqttServer = "8.153.160.138";  // MQTTæœåŠ¡å™¨IP
const int mqttPort = 1883;                       // MQTTç«¯å£
const char* mqttTopic = "txkj/jokker_destop/person_occupancy";            // MQTTä¸»é¢˜
const char* mqttStatusTopic = "txkj/jokker_destop/occupancy_status";      // çŠ¶æ€ä¸»é¢˜

WiFiClient espClient;
PubSubClient mqttClient(espClient);

bool mqttConnected = false;
bool wifiConnected = false;

// å‡½æ•°å‰ç½®å£°æ˜
void connectToWiFi();
void connectToMQTT();
void sendStateToMQTT(bool state, const char* changeType = "state_change");
void sendBootMessage();
void blinkLED(int interval);
void mqttCallback(char* topic, byte* payload, unsigned int length);
void checkStateTimeout();

void setup() {
  Serial.begin(115200);
  pinMode(SENSOR_PIN, INPUT);
  pinMode(LED_PIN, OUTPUT);
  digitalWrite(LED_PIN, LOW);
  
  Serial.println("äººä½“æ£€æµ‹ç³»ç»Ÿå¯åŠ¨ä¸­...");
  Serial.println("==========================");
  
  // è¿æ¥WiFi
  connectToWiFi();
  
  // é…ç½®MQTT
  mqttClient.setServer(mqttServer, mqttPort);
  mqttClient.setCallback(mqttCallback);
  
  // è¿æ¥MQTT
  connectToMQTT();
  
  // åˆå§‹åŒ–çŠ¶æ€å˜åŒ–æ—¶é—´
  lastStateChangeTime = millis();
  lastStatePublishTime = millis();
  
  systemBooted = true;
  Serial.println("äººä½“æ£€æµ‹ç³»ç»Ÿå¯åŠ¨å®Œæˆ");
  Serial.println("==========================");
  
  // å‘é€é‡å¯æ¶ˆæ¯
  sendBootMessage();
}

void connectToWiFi() {
  unsigned long wifiStartTime = millis();
  int blinkCount = 0;
  
  Serial.print("æ­£åœ¨è¿æ¥WiFi: ");
  Serial.println(ssid);
  
  WiFi.begin(ssid, password);
  
  while (WiFi.status() != WL_CONNECTED) {
    // LEDå¿«é€Ÿé—ªçƒï¼ˆæ¯ç§’2æ¬¡ï¼‰
    if (millis() - lastLedBlink > 250) {
      ledState = !ledState;
      digitalWrite(LED_PIN, ledState ? HIGH : LOW);
      lastLedBlink = millis();
      blinkCount++;
    }
    
    if (blinkCount % 8 == 0) { // æ¯2ç§’æ‰“å°ä¸€æ¬¡çŠ¶æ€
      Serial.print(".");
    }
    
    // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡ï¼Œå¦‚æœè¿˜æ˜¯è¿æ¥å¤±è´¥ï¼Œé‡æ–°å¼€å§‹è¿æ¥
    if (millis() - wifiStartTime > 30000) {
      Serial.println("\nWiFiè¿æ¥è¶…æ—¶ï¼Œé‡æ–°å°è¯•...");
      WiFi.disconnect();
      delay(1000);
      WiFi.begin(ssid, password);
      wifiStartTime = millis();
      blinkCount = 0;
    }
    
    delay(10);
  }
  
  // WiFiè¿æ¥æˆåŠŸï¼ŒLEDå¸¸äº®
  digitalWrite(LED_PIN, HIGH);
  wifiConnected = true;
  Serial.println("\nWiFiè¿æ¥æˆåŠŸ!");
  Serial.print("IPåœ°å€: ");
  Serial.println(WiFi.localIP());
}

void connectToMQTT() {
  if (!wifiConnected) {
    Serial.println("WiFiæœªè¿æ¥ï¼Œæ— æ³•è¿æ¥MQTT");
    return;
  }
  
  Serial.print("æ­£åœ¨è¿æ¥MQTTæœåŠ¡å™¨: ");
  Serial.print(mqttServer);
  Serial.print(":");
  Serial.println(mqttPort);
  
  // å°è¯•è¿æ¥MQTT
  if (mqttClient.connect("ESP32_PIR_Sensor")) {
    mqttConnected = true;
    Serial.println("MQTTè¿æ¥æˆåŠŸ!");
    digitalWrite(LED_PIN, HIGH);
  } else {
    mqttConnected = false;
    Serial.print("MQTTè¿æ¥å¤±è´¥ï¼Œé”™è¯¯ä»£ç : ");
    Serial.println(mqttClient.state());
    digitalWrite(LED_PIN, LOW);
  }
}

void mqttCallback(char* topic, byte* payload, unsigned int length) {
  // å¯ä»¥åœ¨è¿™é‡Œå¤„ç†æ¥æ”¶åˆ°çš„MQTTæ¶ˆæ¯
  Serial.print("æ”¶åˆ°MQTTæ¶ˆæ¯: ");
  Serial.println(topic);
}

void sendBootMessage() {
  if (!mqttClient.connected()) {
    Serial.println("MQTTæœªè¿æ¥ï¼Œæ— æ³•å‘é€é‡å¯æ¶ˆæ¯");
    connectToMQTT();
    if (!mqttClient.connected()) {
      return;
    }
  }
  
  String ipAddress = WiFi.localIP().toString();
  String message = "{\"event\":\"reboot\",\"ip\":\"" + ipAddress + 
                   "\",\"message\":\"ç³»ç»Ÿé‡å¯å®Œæˆ\",\"timestamp\":\"" + 
                   String(millis()) + "\"}";
  
  if (mqttClient.publish(mqttStatusTopic, message.c_str())) {
    Serial.println("âœ… é‡å¯æ¶ˆæ¯å‘é€æˆåŠŸ");
  } else {
    Serial.println("âŒ é‡å¯æ¶ˆæ¯å‘é€å¤±è´¥");
  }
}

void sendStateToMQTT(bool state, const char* changeType) {
  if (!mqttClient.connected()) {
    Serial.println("MQTTæœªè¿æ¥ï¼Œæ— æ³•å‘é€çŠ¶æ€æ¶ˆæ¯");
    connectToMQTT();
    if (!mqttClient.connected()) {
      return;
    }
  }
  
  String message;
  String ipAddress = WiFi.localIP().toString();
  String changeTypeStr = changeType;
  
  if (state) {
    message = "{\"state\":\"occupied\",\"ip\":\"" + ipAddress + 
              "\",\"message\":\"æ£€æµ‹åˆ°æœ‰äºº\",\"timestamp\":\"" + 
              String(millis()) + "\",\"change_type\":\"" + changeTypeStr + "\"}";
    if (changeTypeStr == "state_change") {
      Serial.println("ğŸ”´ æ£€æµ‹åˆ°æœ‰äºº - å‘é€MQTTæ¶ˆæ¯");
    } else {
      Serial.println("ğŸ”´ æ£€æµ‹åˆ°æœ‰äºº - å®šæ—¶å‘é€çŠ¶æ€æ¶ˆæ¯");
    }
  } else {
    message = "{\"state\":\"unoccupied\",\"ip\":\"" + ipAddress + 
              "\",\"message\":\"æ— äººçŠ¶æ€\",\"timestamp\":\"" + 
              String(millis()) + "\",\"change_type\":\"" + changeTypeStr + "\"}";
    if (changeTypeStr == "state_change") {
      Serial.println("ğŸŸ¢ æ— äºº - å‘é€MQTTæ¶ˆæ¯");
    } else {
      Serial.println("ğŸŸ¢ æ— äºº - å®šæ—¶å‘é€çŠ¶æ€æ¶ˆæ¯");
    }
  }
  
  if (mqttClient.publish(mqttTopic, message.c_str())) {
    Serial.println("âœ… çŠ¶æ€æ¶ˆæ¯å‘é€æˆåŠŸ");
    lastStatePublishTime = millis(); // æ›´æ–°æœ€åå‘å¸ƒçŠ¶æ€çš„æ—¶é—´
  } else {
    Serial.println("âŒ çŠ¶æ€æ¶ˆæ¯å‘é€å¤±è´¥");
  }
}

void blinkLED(int interval) {
  unsigned long currentMillis = millis();
  if (currentMillis - lastLedBlink >= interval) {
    ledState = !ledState;
    digitalWrite(LED_PIN, ledState ? HIGH : LOW);
    lastLedBlink = currentMillis;
  }
}

void checkConnections() {
  // æ£€æŸ¥WiFiè¿æ¥çŠ¶æ€
  if (WiFi.status() != WL_CONNECTED) {
    wifiConnected = false;
    mqttConnected = false;
    Serial.println("WiFiè¿æ¥ä¸¢å¤±ï¼Œå°è¯•é‡æ–°è¿æ¥...");
    connectToWiFi();
  }
  
  // æ£€æŸ¥MQTTè¿æ¥çŠ¶æ€
  if (wifiConnected && !mqttClient.connected()) {
    mqttConnected = false;
    connectToMQTT();
  }
}

void checkStateTimeout() {
  unsigned long currentTime = millis();
  
  // æ£€æŸ¥æ˜¯å¦5åˆ†é’Ÿæ²¡æœ‰çŠ¶æ€å˜åŒ–
  if (currentTime - lastStateChangeTime >= STATE_CHANGE_INTERVAL) {
    // æ£€æŸ¥æ˜¯å¦å·²ç»å‘é€è¿‡å®šæ—¶çŠ¶æ€ï¼ˆé¿å…è¿ç»­å‘é€ï¼‰
    if (currentTime - lastStatePublishTime >= STATE_CHANGE_INTERVAL) {
      Serial.println("â° 5åˆ†é’Ÿæ— çŠ¶æ€å˜åŒ–ï¼Œå‘é€å½“å‰çŠ¶æ€");
      sendStateToMQTT(currentState, "timeout");
    }
  }
}

void loop() {
  // ç»´æŒMQTTè¿æ¥
  mqttClient.loop();
  
  // å®šæœŸæ£€æŸ¥è¿æ¥çŠ¶æ€ï¼ˆæ¯5ç§’æ£€æŸ¥ä¸€æ¬¡ï¼‰
  static unsigned long lastCheck = 0;
  if (millis() - lastCheck > 5000) {
    checkConnections();
    lastCheck = millis();
  }
  
  // æ£€æŸ¥çŠ¶æ€è¶…æ—¶ï¼ˆæ¯30ç§’æ£€æŸ¥ä¸€æ¬¡ï¼‰
  static unsigned long lastTimeoutCheck = 0;
  if (millis() - lastTimeoutCheck > 30000) {
    checkStateTimeout();
    lastTimeoutCheck = millis();
  }
  
  // æ ¹æ®è¿æ¥çŠ¶æ€æ§åˆ¶LED
  if (!wifiConnected) {
    // WiFiæœªè¿æ¥ï¼Œå¿«é€Ÿé—ªçƒ
    blinkLED(250);
  } else if (!mqttConnected) {
    // WiFiå·²è¿æ¥ä½†MQTTæœªè¿æ¥ï¼Œä¸­é€Ÿé—ªçƒ
    blinkLED(500);
  } else {
    // å…¨éƒ¨è¿æ¥æ­£å¸¸ï¼ŒLEDå¸¸äº®
    digitalWrite(LED_PIN, HIGH);
  }
  
  // è¯»å–ä¼ æ„Ÿå™¨çŠ¶æ€
  currentState = digitalRead(SENSOR_PIN);
  
  // åªæœ‰å½“çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶æ‰å¤„ç†
  if (currentState != lastState) {
    if (currentState == HIGH) {
      Serial.println("ğŸ”´ æ£€æµ‹åˆ°æœ‰äºº");
    } else {
      Serial.println("ğŸŸ¢ æ— äºº");
    }
    
    // å‘é€MQTTæ¶ˆæ¯
    if (systemBooted) {
      sendStateToMQTT(currentState, "state_change");
    }
    
    // æ›´æ–°çŠ¶æ€å˜åŒ–æ—¶é—´
    lastStateChangeTime = millis();
    
    // æ›´æ–°ä¸Šä¸€æ¬¡çš„çŠ¶æ€
    lastState = currentState;
  }
  
  delay(100);  // æ¯100msæ£€æµ‹ä¸€æ¬¡
}